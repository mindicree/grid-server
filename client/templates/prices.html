{% extends 'template.html' %}

{% block page_title %}
G-COMM | GRID Server
{% endblock %}

{% block body %}
<!-- Search Tool -->
<div class="search-tools-container">
    <div class="input-group" style="width: 70%; margin: auto;">
        <input type="text" class="form-control" placeholder="Search by Name">
        <button id='btnPriceSearch' type="button" name="button"><img src="https://cdn.onlinewebfonts.com/svg/img_588.png" width="24px" height="24px" style="margin: auto 20px;" onclick="alert('search')"></img></button>
    </div>
</div>

<!-- Mobile filter Hamburger -->
<a data-bs-toggle="offcanvas" href="#offcanvasFilter" role="button" aria-controls="offcanvasFilter">
    <div id='mobileFilterBtn'>
        <img src="static/img/hamburger.png" alt="">
    </div>
</a>

<!-- Table And Flter Tabs -->
<div id='priceTableFilterComboContainer'>
    <div id='priceTableContainer'>
        <table class='table table-striped table-hover table-bordered' id='tablePriceList'>
            <thead>
                <tr>
                    <th>Name</th>
                    <th style="width: 25%;">Price</th>
                </tr>
            </thead>
            <tbody id='tablePriceListBody'>
        
            </tbody>
        </table>
    </div>
    <div id='priceListFilterDivider' style='width: 1px; position: relative; left: 50%; background-color: #ccc;'></div>
    <div id='priceFilterContainer'>
        <div class="accordion" id="accordianFull">

        </div>
    </div>
    <!-- Mobile off canvas for filters -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasFilter" aria-labelledby="offcanvasFilterLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasExampleLabel">Filters</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="accordion" id="accordianMobile">

            </div>
        </div>
    </div>
</div>

<!--Loading Thing-->
<div id='table_loading_indicator' style='display: grid; width: 100%; margin: auto; padding-top: 50px;'>
    <img src='static/img/loading.gif' style='width: 64px; height: 64px; margin: auto;'>
    <h4 style="color: #aaa; margin: auto;">Loading</h4>
</div>

<!-- LOAD Table with data -->
<script>
    let price_list;
    let price_list_filter = [];
    let filter_list = [];
    let categories;
    fetch('http://{{ host_ip }}:5000/prices')
    .then(response => response.json())
    .then(data => {
        price_list = data['price_list']
        categories = data['categories']

        // Sort price list by name
        price_list.sort((a, b) => {
            return a.name > b.name;
        })

        // Load price items into table
        price_list.forEach(element => {
            document.querySelector('#tablePriceListBody').innerHTML += generateTableRow(element)
        });

        // Load categories into side and mobile filters
        for (let c in categories) {
            document.querySelector('#accordianFull').innerHTML += getCategoryAccordian(categories[c], c)
            document.querySelector('#accordianMobile').innerHTML += getCategoryAccordian(categories[c], c)
        }

        //hide loading thing
        document.querySelector('#table_loading_indicator').style.display = 'none';
    })
    .catch(error => {
        console.log(error)
    })

    function getCategoryAccordian(item, itemName) {
        if (itemName != 'price_code') {
            return '' +  
            '<div class="accordion-item">' + 
                '<h2 class="accordion-header" id="categoryFullHeader'+itemName+'">' +
    '                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#categoryFullBody'+itemName+'" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">'+itemName.replace('_', ' ')+'</button>' + 
                '</h2>' +
                '<div id="categoryFullBody'+itemName+'" class="accordion-collapse collapse" aria-labelledby="categoryFullHeader'+itemName+'">' +
                    '<div class="accordion-body">' +
                        getCategoryCheckList(item, itemName) + 
                    '</div>' + 
                '</div>' + 
            '</div>';
        }
        return ''
    }

    function getCategoryCheckList(item, itemName) {
        let checkList = '';
        for (let i = 0; i < item.length; i++) {
            checkList += 
            '<div style="display: grid; grid-template-columns:  20% auto; width: 100%; padding-bottom: 10px;">' + 
                '<input type="checkbox" name="checkbox_'+itemName+'_'+item[i]+'" onclick="toggleFilter(this)">' +
                '<label for="checkbox_'+itemName+'_'+item[i]+'" >'+item[i]+'</label>' + 
            '</div>';
        }
        return checkList;
    }

    function toggleFilter(checkbox) {
        console.log((checkbox.checked ? 'Checked ' : 'Unchecked ') + checkbox.name);
        document.getElementsByName(checkbox.name).forEach(element => {
            element.checked = checkbox.checked;
        })
        if (checkbox.checked) {

        } else {

        }
    }

    function generateTableRow(item) {
        let currentPrice = getCurrentPrice(item);
        return '' +
        '<tr id="tr_'+item._id+'"onclick="displayPriceInfo(this)">' +
            '<td>' + item.name +'</td>' + 
            '<td>$' + currentPrice + '</td>' + 
        '</tr>'; 
    }

    function getCurrentPrice(item) {
        let price = 0;
        let price_history = item.price_history;
        let latestDate = new Date('1970-01-01');
        let elementDate;
        price_history.forEach(element => {
            elementDate = new Date(element.date)
            if (elementDate > latestDate) {
                price = element.price
            }
        })
        return price
    } 

    function displayPriceInfo(table_row) {
        alert(table_row.id)
    }
</script>


{% endblock %}