{% extends 'template.html' %}

{% block page_title %}
Work Orders | GRID Server
{% endblock %}

{% block body %}

<div id='workOrderEditContainer'>

</div>

<!-- Phone No Format SCRIPT -->
<script>
    //from stackoverflow
    //https://stackoverflow.com/questions/8358084/regular-expression-to-reformat-a-us-phone-number-in-javascript
    function formatPhoneNumberToDigits(phoneNumberString) {
        var cleaned = phoneNumberString.replace(/\D/g, '');
        if (cleaned.length == 10) {
            return cleaned;
        }
        return null;
    }
    function formatPhoneNumberToView(phoneNumberString) {
        var cleaned = ('' + phoneNumberString).replace(/\D/g, '');
        var match = cleaned.match(/^(\d{3})(\d{3})(\d{4})$/);
        if (match) {
            return '(' + match[1] + ') ' + match[2] + '-' + match[3];
        }
        return null;
    }

    //my format date function
    function formatDateString(dateString) {
        date = new Date(dateString);
        dateFormat = {
            weekday: 'short',
            day: 'numeric',
            month: 'short',
            year: 'numeric',
            hour: 'numeric',
            minute: 'numeric'
        }
        return date.toLocaleDateString('en-UK', dateFormat);
    }
</script>

<!-- GET WORK ORDER -->
<script>
    let workOrderOriginal, workOrderEdit;
    fetch('http://{{ host_ip }}:5000/work-orders/{{ wo_id }}')
    .then(response => response.json())
    .then(data => {
        workOrderOriginal = data;
        worOrderEdit = data;
    })
    .catch(error => {
        document.querySelector('body').innerHTML += error;
        console.log(error);
    });

    function getModalBodyString(wo) {
        let bodyString = 
                '<div>' +
                    '<p><b>Name: </b>' + wo.fname + ' ' + wo.lname + '</p>' +
                    '<p><b>Computer: </b>' + wo.model + ' (' + wo.computer_type + ')</p>' +
                    '<p><b>Issue: </b>' + wo.issue_category + ' - ' + wo.issue_description + '</p>' +
                    '<p><b>Bought From Us: </b>' + (wo.isPurchasedFromUs ? 'Yes' : 'No') + '</p>' +
                    '<p><b>Under Warranty: </b>' + (wo.isUnderWarranty ? 'Yes' : 'No') + '</p>' +
                    '<p><b>Other Items: </b>' + (wo.isWithOtherItems.length > 0 ? wo.isWithOtherItems : 'No') + '</p>' +
                    '<hr>' + 
                    (wo.starting_tech == wo.finishing_tech ? '<p><b>Tech: </b>' + wo.starting_tech + '</p>' : '<p><b>Techs: </b>' + wo.starting_tech + ', ' + wo.finishing_tech + '</p>') + 
                    '<p><b>Date of Completion: </b>' + formatDateString(wo.dt_completed) + '</p>' +
                    '<p><b>Price: </b>' + (wo.price == null || wo.price <= 0 ? '$0.00': Intl.NumberFormat('en-US', {style: 'currency', currency: 'USD'}).format(wo.price)) + '</p>' +
                    '<p><b>Notes: </b></p><br>' +
                    '<p>'+wo.notes+'</p>' +
                '</div>';
        
        return bodyString;
    }

    function generateDateBox (woData) {
        let now = new Date();
        let takeIn = new Date(woData.dt_recieved);
        let deltaTimeMilliseconds = now - takeIn; //date subtraction returns milliseconds
        let deltaTimeHours = deltaTimeMilliseconds / 1000 / 3600;
        //console.log('Name: ' + woData.fname + ' ' + woData.lname + '\nNow: ' + now + '\nDT_Recieved: ' + takeIn + '\ndeltaTimeMilliseconds: ' + deltaTimeMilliseconds + '\ndeltaTimeHours: ' + deltaTimeHours + '\n')
        let colorBoxString, colorRed, colorGreen;

        if (deltaTimeHours <= 24) {
            //10.625 RGB per hour up to 255 at 24 hours
            colorRed = (deltaTimeHours * 10.625);
            colorGreen = 255; 
            colorBoxString = 
            '<div class="date_color_box" style="background-color: rgb('+colorRed+', 255, 0);">' + 
            '</div>';
        } else if (deltaTimeHours <= 48) {
            //10.625 RGB per hour up to 255 at 24 hours
            colorRed = 255;
            colorGreen = 255 - ((deltaTimeHours - 24) * 10.625); 
            colorBoxString = 
            '<div class="date_color_box" style="background-color: rgb(255, '+colorGreen+', 0);">' + 
            '</div>';
        } else {
            colorBoxString = 
            '<div class="date_color_box" style="background-color: rgb(255, 0, 0);">' + 
            '</div>';
        }
        return colorBoxString;
    }
</script>

  
{% endblock %}